# Gameplay Message Router: Делегаты 2.0

Unreal Engine предлагает мощные инструменты для обработки событий и взаимодействия компонентов: делегаты, интерфейсы, сообщения и многое другое. Однако стандартных средств бывает недостаточно. Здесь на сцену выходит **Gameplay Message Router** — элегантный и модульный подход к управлению событиями и передачей данных.

Давайте разберемся, почему `Gameplay Message Router` я назвал **"делегатами 2.0",** почему это не совсем правильно, как он работает и когда его стоит использовать.

***

### Что такое Gameplay Message Router?

`Gameplay Message Router` по своей сути представляет реализацию паттерна проектирования [Message Bus](https://www.enterpriseintegrationpatterns.com/patterns/messaging/MessageBus.html). Вы можете создавать сколько угодно каналов, отправлять по ним любые сообщения в виде структур. Главное, чтобы на обоих концах (отправитель/принимающий) были согласованы типы данных.

***

## Разница между Делегатами и Message Bus

Когда дело доходит до управления событиями в программировании, **делегаты** и **Message Bus** представляют два подхода, каждый из которых имеет свои сильные стороны. Понимание их различий и областей применения помогает выбрать подходящий инструмент для каждой задачи.

***

### Что такое делегаты?

**Делегаты** — это механизм подписки и вызова функций, используемый для связи между объектами. Делегаты позволяют отправителю (инициатору события) вызывать заранее зарегистрированные функции (подписчиков).

**Преимущества делегатов:**

1. **Простота и эффективность.** Делегаты вызывают функции напрямую, что делает их быстрыми и простыми в реализации.
2. **Статическая типизация.** Подписчики строго соответствуют определенному типу делегата, что уменьшает ошибки.
3. **Прямое управление.** Отправитель знает, что функция будет вызвана, и может управлять процессом.

**Недостатки делегатов:**

1. **Жесткая связь**. Подписчики и отправители должны знать друг о друге, что создает тесную связь между системами.&#x20;
2. **Сложность в масштабировании**. Когда слишком много объектов должны узнать о каком-то узком событии, им придется
3. **Риск** [dangling references ](https://en.wikipedia.org/wiki/Dangling_pointer)(частный случай утечки памяти).

***

### Что такое Message Bus?

**Message Bus** (реализованный в Unreal Engine через **Gameplay Message Router**) — это архитектурный шаблон для маршрутизации сообщений между компонентами. Он создает централизованную точку для отправки сообщений и их получения.

**Преимущества Message Bus:**

1. **Отсутствие зависимости между отправителем и получателем.** Отправитель не знает, кто обрабатывает его сообщение.
2. **Гибкость подписки.** Подписчики могут подписываться на события по тегам или другим идентификаторам.
3. **Масштабируемость.** Легко управляет большим количеством сообщений в сложных системах.
4. **Универсальность.** Может обрабатывать различные типы данных без необходимости менять архитектуру.

**Недостатки Message Bus:**

1. **Производительность.** Из-за централизованной маршрутизации может быть менее эффективным, чем прямой вызов делегатов.
2. **Сложность.** Требует дополнительной настройки и правильной организации системы.
3. **Динамическая типизация.** Payload сообщений может потребовать ручной проверки типов.

***

#### Сравнение делегатов и Message Bus

| **Характеристика**      | **Делегаты**                           | **Message Bus**                        |
| ----------------------- | -------------------------------------- | -------------------------------------- |
| **Связь**               | Прямая (отправитель знает подписчиков) | Косвенная (через центральный менеджер) |
| **Масштабируемость**    | Ограниченная                           | Высокая                                |
| **Производительность**  | Высокая                                | Средняя                                |
| **Фильтрация событий**  | Ручная                                 | Автоматическая (через Gameplay Tags)   |
| **Простота реализации** | Простая                                | Сложнее                                |
| **Типизация данных**    | Статическая                            | Чаще динамическая                      |
| **Гибкость подписки**   | Ограниченная                           | Любая                                  |
| **Подходит для**        | Простых и локальных взаимодействий     | Сложных и распределенных систем        |

***

#### Когда использовать делегаты?

1. **Простые взаимодействия между двумя объектами.**\
   Например: кнопка включает свет.
2. **Высокочастотные события.**\
   Например: обновление UI при изменении здоровья игрока.
3. **Когда нужна максимальная производительность.**\
   Делегаты вызываются напрямую, что минимизирует накладные расходы.
4. **Статическая структура.**\
   Если отправитель и подписчики заранее известны и редко меняются.

***

#### Когда использовать Message Bus?

1. **Сложные системы взаимодействия.**\
   Например: система квестов, реагирующая на глобальные игровые события (победа в бою, завершение диалога).
2. **Разделение систем.**\
   Например: инвентарь, логика квестов и HUD не должны знать о внутреннем устройстве друг друга.
3. **Масштабируемые проекты.**\
   Например: многопользовательская игра, где события (например, уничтожение объекта) должны быть обработаны сразу несколькими системами.
4. **Динамическая структура.**\
   Если подписчики могут меняться в процессе игры.

***

#### Комбинация делегатов и Message Bus

В реальных проектах нередко используется **комбинация** этих подходов:

* **Локальные события** (например, взаимодействие с объектом) обрабатываются через делегаты.
* **Глобальные события** (например, обновление игрового состояния) маршрутизируются через Message Bus.

#### Пример:

1. **Квестовая система** слушает событие `Event.EnemyDefeated` через Message Bus.
2. После получения события она через делегат вызывает локальную функцию обновления состояния текущего квеста.

***

